<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout}"
>
  <head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}" />
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω b√°n h√†ng</title>
  </head>
  <body>
    <div layout:fragment="content">
      <div class="space-y-6">
        <!-- Ti√™u ƒë·ªÅ -->
        <h2 class="text-2xl font-bold text-[#4e342e]">üìã S∆° ƒë·ªì b√†n</h2>

        <!-- Grid b√†n -->
        <div class="grid grid-cols-5 gap-4 w-fit mx-auto">
          <div
            th:each="table : ${tables}"
            class="flex flex-col items-center justify-center aspect-square rounded-xl font-semibold text-center shadow-md w-24 p-2 transition duration-200"
            th:classappend="${table.status == 'AVAILABLE'}
             ? 'bg-green-100 text-green-800 hover:bg-green-200 cursor-pointer'
             : (${table.status == 'RESERVED'}
                ? 'bg-yellow-100 text-yellow-800'
                : 'bg-gray-300 text-gray-700 hover:bg-gray-400')"
          >
            <!-- Checkbox lu√¥n ch·ªçn ƒë∆∞·ª£c -->
            <input
              type="checkbox"
              th:id="'table-' + ${table.id}"
              th:value="${table.id}"
              class="mb-1 table-checkbox"
              name="selectedTable"
            />

            <!-- T√™n b√†n -->
            <label
              th:for="'table-' + ${table.id}"
              th:text="${table.tableName}"
            ></label>

            <!-- Tr·∫°ng th√°i c√≥ icon -->
            <span class="text-xs mt-1 flex items-center gap-1">
              <span th:if="${table.status == 'AVAILABLE'}">üü¢ Tr·ªëng</span>
              <span th:if="${table.status == 'OCCUPIED'}">üî¥ ƒêang s·ª≠ d·ª•ng</span>
              <span th:if="${table.status == 'RESERVED'}">üü° ƒê·∫∑t tr∆∞·ªõc</span>
            </span>
          </div>
        </div>

        <!-- C√°c n√∫t thao t√°c -->
        <div class="flex flex-wrap gap-3 justify-center mt-6">
          <a
            th:href="@{/sale/create}"
            class="inline-block bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            ‚ûï Th√™m b√†n
          </a>
          <button
            type="button"
            onclick="showSelectedTables()"
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            üëÅÔ∏è Xem b√†n
          </button>
          <button
                  type="button"
                  onclick="openTransferModalFromSelection()"
                  class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600"
          >
            Chuy·ªÉn b√†n
          </button>
          <button
            class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600"
          >
            T√°ch b√†n
          </button>
          <button onclick="openModalMergeTable()"
            class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600"
          >
            G·ªôp b√†n
          </button>
          <form id="cancelForm" th:action="@{/sale/cancel}" method="post" style="display:inline;">
            <input type="hidden" name="tableId" id="cancelTableId" />
            <button
                    type="button"
                    class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                    onclick="cancelSelectedTable()"
            >
              H·ªßy b√†n
            </button>
          </form>
          <button
                  type="button"
                  class="bg-blue-600 text-white px-4 py-2 rounded"
                  onclick="redirectToReservationForm()"
          >
            ƒê·∫∑t b√†n
          </button>
        </div>

        <!-- Menu, Thanh to√°n, In -->
        <div class="grid grid-cols-3 gap-4 max-w-4xl mx-auto mt-4">
          <button
                  type="button"
                  class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                  onclick="openMenuModal()"
          >
            Ch·ªçn th·ª±c ƒë∆°n
          </button>
          <button
                  type="button"
                  class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700"
                  onclick="confirmPayment()"
          >
            üí≥ Thanh to√°n
          </button>
          <button
            class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
          >
            üñ®Ô∏è In h√≥a ƒë∆°n
          </button>
        </div>
      </div>

      <!-- Modal hi·ªÉn th·ªã chi ti·∫øt b√†n -->
      <div
        id="detailModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
      >
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
          <h2 class="text-xl font-bold mb-4">ü™ë Chi ti·∫øt b√†n</h2>
          <div id="modalContent" class="space-y-2">
            <p><strong>T√™n b√†n:</strong> <span id="tableName"></span></p>
            <p><strong>Tr·∫°ng th√°i:</strong> <span id="tableStatus"></span></p>
          </div>
          <button
            onclick="closeDetailModal()"
            class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
          >
            ‚úñÔ∏è
          </button>
        </div>
      </div>

      <!-- Modal ch·ªçn th·ª±c ƒë∆°n -->
      <div id="menuModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
          <button onclick="closeMenuModal()" class="absolute top-2 right-2 text-gray-400 hover:text-black text-2xl">&times;</button>
          <h2 class="text-xl font-bold mb-4 text-green-700">Ch·ªçn th·ª±c ƒë∆°n cho b√†n</h2>
          <form id="menuForm" th:action="@{/sale/select-menu}" method="post">
            <input type="hidden" name="tableId" id="menuTableId" />
            <div class="max-h-60 overflow-y-auto mb-4 space-y-2">
              <div th:each="menu : ${menus}" class="flex items-center gap-2">
                <input
                        type="checkbox"
                        class="menu-checkbox"
                        name="menuIds"
                        th:value="${menu.id}"
                />
                <span th:text="${menu.itemName}" class="flex-1"></span>
                <div class="flex items-center gap-1">
                  <button type="button"
                          class="decrement bg-gray-200 px-2 rounded disabled:opacity-50"
                          disabled>-</button>
                  <input type="number"
                         name="quantities"
                         min="1"
                         value="1"
                         class="menu-quantity w-12 text-center border rounded py-0.5"
                         disabled />
                  <button type="button"
                          class="increment bg-gray-200 px-2 rounded disabled:opacity-50"
                          disabled>+</button>
                </div>
              </div>
            </div>

            <div id="menuModalMsg" class="text-red-500 text-sm mb-2"></div>
            <button type="button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded" onclick="submitMenuForm()">L∆∞u th·ª±c ƒë∆°n</button>
          </form>
        </div>
      </div>


      <!-- Modal thanh to√°n -->
      <div
              id="paymentModal"
              class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
      >
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
          <!-- Ti√™u ƒë·ªÅ -->
          <h2 class="text-xl font-bold mb-4 text-teal-700">
            üí≥ Thanh to√°n <span id="paymentTableName"></span>
          </h2>

          <!-- Danh s√°ch m√≥n ƒÉn -->
          <div class="border rounded mb-4 max-h-52 overflow-y-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-100">
              <tr>
                <th class="p-2 text-left">T√™n m√≥n</th>
                <th class="p-2 text-center">SL</th>
                <th class="p-2 text-right">Th√†nh ti·ªÅn</th>
              </tr>
              </thead>
              <tbody id="paymentItems">
              <!-- JS s·∫Ω render -->
              </tbody>
            </table>
          </div>

          <!-- T·ªïng ti·ªÅn -->
          <div class="flex justify-between mb-3">
            <span class="font-semibold">T·ªïng:</span>
            <span id="paymentTotal" class="font-bold text-teal-700">0 ƒë</span>
          </div>

          <!-- Kh√°ch ƒë∆∞a -->
          <div class="flex items-center gap-2 mb-3">
            <label class="whitespace-nowrap font-semibold">Kh√°ch ƒë∆∞a:</label>
            <input
                    type="number"
                    id="customerPay"
                    min="0"
                    value="0"
                    class="border rounded w-full px-2 py-1 text-right"
                    oninput="calculateChange()"
            />
          </div>

          <!-- Ti·ªÅn th·ªëi -->
          <div class="flex justify-between mb-3">
            <span class="font-semibold">Th·ªëi l·∫°i:</span>
            <span id="changeAmount" class="font-bold">0 ƒë</span>
          </div>

          <!-- Checkbox ƒë·ªïi tr·∫°ng th√°i -->
          <div class="mb-4 flex items-center gap-2">
            <input type="checkbox" id="autoSetEmpty" checked />
            <label for="autoSetEmpty" class="text-sm">ƒê·ªïi tr·∫°ng th√°i b√†n sang tr·ªëng sau khi thanh to√°n</label>
          </div>

          <!-- N√∫t in phi·∫øu -->
          <button
                  onclick="printReceipt()"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-3 rounded w-full mb-3"
          >
            üñ®Ô∏è In phi·∫øu thanh to√°n...
          </button>

          <!-- N√∫t x√°c nh·∫≠n + h·ªßy -->
          <div class="flex gap-3">
            <button
                    id="confirmPaymentBtn"
                    class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded w-full"
            >
              ‚úÖ Thanh to√°n
            </button>
            <button
                    onclick="closePaymentModal()"
                    class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded w-full"
            >
              ‚ùå H·ªßy
            </button>
          </div>

          <!-- N√∫t ƒë√≥ng g√≥c tr√™n -->
          <button
                  onclick="closePaymentModal()"
                  class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
          >
            ‚úñÔ∏è
          </button>
        </div>
      </div>

      <!-- Modal chuy·ªÉn b√†n -->
      <div id="transferModal"
           class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm relative">
          <h2 class="text-lg font-bold mb-4">Chuy·ªÉn b√†n <span id="fromTableName"></span></h2>

          <form id="transferForm" th:action="@{/sale/transfer}" method="post">
            <input type="hidden" name="fromTableId" id="fromTableId"/>
            <label class="block mb-2 font-semibold">Ch·ªçn b√†n c·∫ßn chuy·ªÉn ƒë·∫øn:</label>
            <select name="toTableId" id="toTableSelect"
                    class="border rounded w-full px-2 py-1 mb-4">
              <option value="">-- Ch·ªçn b√†n --</option>
              <option th:each="table : ${tables}"
                      th:if="${table.status == 'AVAILABLE'}"
                      th:value="${table.id}"
                      th:text="${table.tableName}"></option>
            </select>

            <div id="transferError" class="text-red-500 text-sm mb-2"></div>

            <div class="flex justify-end gap-2">
              <button type="button"
                      onclick="closeTransferModal()"
                      class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-1 rounded">H·ªßy</button>
              <button type="button"
                      onclick="submitTransferForm()"
                      class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">Chuy·ªÉn</button>
            </div>
          </form>

          <button onclick="closeTransferModal()"
                  class="absolute top-2 right-2 text-gray-400 hover:text-black text-3xl">&times;</button>
        </div>
      </div>

      <!-- Modal g·ªôp b√†n -->
      <div id="mergeTableModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-xl shadow-lg">
          <h2 class="text-xl font-semibold mb-4">G·ªôp b√†n</h2>

          <form id="mergeTableForm" th:action="@{/sale/merge}" method="post">
            <div class="flex justify-between gap-4">
              <!-- Danh s√°ch b√†n c·∫ßn g·ªôp (b√†n ƒëang s·ª≠ d·ª•ng) -->
              <div class="w-1/2">
                <h3 class="font-medium mb-2">Ch·ªçn c√°c b√†n c·∫ßn g·ªôp</h3>
                <div class="max-h-40 overflow-y-auto border rounded p-2 space-y-2">
                  <div th:each="table : ${tables}" th:if="${table.status == 'OCCUPIED'}">
                    <label>
                      <input type="checkbox" class="merge-source" name="sourceTableIds" th:value="${table.id}" />
                      <span th:text="${table.tableName}"></span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Ch·ªçn b√†n g·ªôp ƒë·∫øn (tr·ªëng ho·∫∑c ƒëang s·ª≠ d·ª•ng) -->
              <div class="w-1/2">
                <h3 class="font-medium mb-2">Ch·ªçn b√†n g·ªôp ƒë·∫øn</h3>
                <div class="max-h-40 overflow-y-auto border rounded p-2 space-y-2">
                  <div th:each="table : ${tables}" th:if="${table.status == 'OCCUPIED' or table.status == 'AVAILABLE'}">
                    <label>
                      <input type="radio" name="targetTableId" class="merge-target" th:value="${table.id}" />
                      <span th:text="${table.tableName}"></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- N√∫t h√†nh ƒë·ªông -->
            <div class="mt-6 flex justify-end gap-4">
              <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">G·ªôp</button>
              <button type="button" onclick="closeModalMergeTable()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">H·ªßy</button>
            </div>
          </form>
        </div>
      </div>

      <script>
        // xem th√¥ng tin b√†n
        // Ch·ªâ cho ph√©p ch·ªçn 1 checkbox b√†n
        document.querySelectorAll("input.table-checkbox").forEach((cb) => {
          cb.addEventListener("change", function () {
            if (this.checked) {
              document
                      .querySelectorAll("input.table-checkbox")
                      .forEach((other) => {
                        if (other !== this) other.checked = false;
                      });
            }
          });
        });


        function showSelectedTables() {
          const checkbox = document.querySelector('input[name="selectedTable"]:checked');
          if (!checkbox) {
            showWarning("Vui l√≤ng ch·ªçn m·ªôt b√†n ƒë·ªÉ xem.");
            return;
          }

          const tableDiv = checkbox.closest("div");
          const statusSpan = tableDiv.querySelector(".text-xs span");
          const statusText = statusSpan ? statusSpan.textContent.trim() : "";

          if (statusText === "üü¢ Tr·ªëng") {
            showWarning("B√†n ƒëang tr·ªëng, ch∆∞a c√≥ d·ªØ li·ªáu chi ti·∫øt ƒë·ªÉ xem!");
            return;
          }
          const id = checkbox.value;
          fetch("/sale/api/view/" + id)
                  .then((res) => {
                    if (!res.ok) throw new Error("HTTP error " + res.status);
                    return res.json();
                  })
                  .then((data) => {
                    console.log("data", data);
                    const modalContent = document.getElementById("modalContent");

                    let statusText = "";
                    if (data.status === "AVAILABLE") {
                      statusText = "üü¢ Tr·ªëng";
                    } else if (data.status === "RESERVED") {
                      statusText = "üü° ƒê·∫∑t tr∆∞·ªõc";
                    } else {
                      statusText = "üî¥ ƒêang s·ª≠ d·ª•ng";
                    }

                    let menuHtml = "";
                    if (data.menuItems && data.menuItems.length > 0) {
                      menuHtml = "<ul class='list-disc ml-5'>";
                      data.menuItems.forEach((item) => {
                        menuHtml += `<li>${item.itemName} - SL: ${item.quantity} - Gi√°: ${
                                item.price
                                        ? item.price.toLocaleString()
                                        : "0"
                        }ƒë</li>`;
                      });
                      menuHtml += "</ul>";
                      // Th√™m t·ªïng ti·ªÅn
                      menuHtml += `<p class="mt-2"><strong>T·ªïng ti·ªÅn:</strong> ${
                              data.totalPrice ? data.totalPrice.toLocaleString() : "0"
                      } ƒë</p>`;
                    } else {
                      menuHtml = "<em>Ch∆∞a c√≥ th·ª±c ƒë∆°n</em>";
                    }

                    const customerInfo = data.customerName
                            ? `<p><strong>Kh√°ch h√†ng:</strong> ${data.customerName} (${
                                    data.customerPhone || "N/A"
                            })</p>`
                            : "";

                    const reservationDate = data.reservationDate
                            ? `<p><strong>Ng√†y ƒë·∫∑t:</strong> ${new Date(
                                    data.reservationDate
                            ).toLocaleString()}</p>`
                            : "";

                    modalContent.innerHTML = `
                  <p><strong>T√™n b√†n:</strong> ${data.tableName}</p>
                  <p><strong>Tr·∫°ng th√°i:</strong> ${statusText}</p>
                  ${customerInfo}
                  ${reservationDate}
                  <p><strong>Th·ª±c ƒë∆°n ƒë√£ ch·ªçn:</strong></p>
                  ${menuHtml}
                `;
                    document.getElementById("detailModal").classList.remove("hidden");
                  })
                  .catch((err) => {
                    console.error(err);
                    showError("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu b√†n!");
                  });
        }


        function closeDetailModal() {
          document.getElementById("detailModal").classList.add("hidden");
        }


        // ƒë·∫∑t b√†n
        function redirectToReservationForm() {
          const checked = document.querySelector('input[name="selectedTable"]:checked');
          if (!checked) {
            showWarning('Vui l√≤ng ch·ªçn m·ªôt b√†n!');
            return;
          }
          // L·∫•y tr·∫°ng th√°i b√†n t·ª´ DOM
          const tableDiv = checked.closest('div');
          const statusSpan = tableDiv.querySelector('.text-xs span');
          const statusText = statusSpan ? statusSpan.textContent.trim() : '';
          if (statusText !== "üü¢ Tr·ªëng") {
            showWarning('Ch·ªâ ƒë∆∞·ª£c ƒë·∫∑t b√†n khi b√†n ƒëang tr·ªëng!');
            return;
          }
          window.location.href = '/sale/reservation?tableId=' + checked.value;
        }

        // h·ªßy b√†n
        function cancelSelectedTable() {
          const checked = document.querySelector('input[name="selectedTable"]:checked');
          if (!checked) {
            showWarning('Vui l√≤ng ch·ªçn m·ªôt b√†n ƒë·ªÉ h·ªßy!');
            return;
          }
          // L·∫•y tr·∫°ng th√°i b√†n t·ª´ DOM
          const tableDiv = checked.closest('div');
          const statusSpan = tableDiv.querySelector('.text-xs span');
          const statusText = statusSpan ? statusSpan.textContent.trim() : '';
          if (statusText === "üü¢ Tr·ªëng" || statusText === "üî¥ ƒêang s·ª≠ d·ª•ng") {
            showWarning('Ch·ªâ c√≥ b√†n ƒë·∫∑t tr∆∞·ªõc m·ªõi ƒë∆∞·ª£c h·ªßy!');
            return;
          }
          showConfirm(
                  'X√°c nh·∫≠n h·ªßy b√†n',
                  'B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy b√†n n√†y?',
                  function() {
                    document.getElementById('cancelTableId').value = checked.value;
                    document.getElementById('cancelForm').submit();
                  }
          );
        }

        //ch·ªçn th·ª±c ƒë∆°n
        function openMenuModal() {
          const checked = document.querySelector('input[name="selectedTable"]:checked');
          if (!checked) {
            showWarning('Vui l√≤ng ch·ªçn m·ªôt b√†n!');
            return;
          }

          document.getElementById('menuTableId').value = checked.value;
          document.querySelectorAll('#menuModal input[type=checkbox]').forEach(cb => cb.checked = false);
          document.getElementById('menuModalMsg').innerText = '';
          document.getElementById('menuModal').classList.remove('hidden');
        }

        function closeMenuModal() {
          document.getElementById('menuModal').classList.add('hidden');
        }

        function submitMenuForm() {
          const checkedMenus = document.querySelectorAll('#menuModal input[name="menuIds"]:checked');
          if (checkedMenus.length === 0) {
            document.getElementById('menuModalMsg').innerText = 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th·ª±c ƒë∆°n!';
            return;
          }
          let isValid = true;
          checkedMenus.forEach(cb => {
            const qtyInput = cb.parentElement.querySelector('.menu-quantity');
            const val = parseInt(qtyInput.value);
            if (isNaN(val) || val < 1) {
              isValid = false;
            }
          });
          if (!isValid) {
            document.getElementById('menuModalMsg').innerText = 'S·ªë l∆∞·ª£ng ph·∫£i t·ª´ 1 tr·ªü l√™n!';
            return;
          }
          document.getElementById('menuForm').submit();
        }

        // B·∫≠t/t·∫Øt input v√† n√∫t + -
        document.querySelectorAll('#menuModal .menu-checkbox').forEach(cb => {
          cb.addEventListener('change', function() {
            const quantityInput = this.parentElement.querySelector('.menu-quantity');
            const decrementBtn = this.parentElement.querySelector('.decrement');
            const incrementBtn = this.parentElement.querySelector('.increment');
            const enabled = this.checked;
            quantityInput.disabled = !enabled;
            decrementBtn.disabled = !enabled;
            incrementBtn.disabled = !enabled;
            if (enabled && quantityInput.value.trim() === '') {
              quantityInput.value = '1';
            }
          });
        });

        // N√∫t tƒÉng
        document.querySelectorAll('#menuModal .increment').forEach(btn => {
          btn.addEventListener('click', function() {
            const input = this.parentElement.querySelector('.menu-quantity');
            let val = parseInt(input.value) || 1;
            input.value = val + 1;
          });
        });

        // N√∫t gi·∫£m
        document.querySelectorAll('#menuModal .decrement').forEach(btn => {
          btn.addEventListener('click', function() {
            const input = this.parentElement.querySelector('.menu-quantity');
            let val = parseInt(input.value) || 1;
            if (val > 1) input.value = val - 1;
          });
        });

        //thanh to√°n
        let currentPaymentData = null;

        function confirmPayment() {
          const checked = document.querySelector('input[name="selectedTable"]:checked');
          if (!checked) {
            showWarning('Vui l√≤ng ch·ªçn m·ªôt b√†n ƒë·ªÉ thanh to√°n!');
            return;
          }

          // L·∫•y tr·∫°ng th√°i b√†n t·ª´ DOM
          const tableDiv = checked.closest('div');
          const statusSpan = tableDiv.querySelector('.text-xs span');
          const statusText = statusSpan ? statusSpan.textContent.trim() : '';

          // Ki·ªÉm tra tr·∫°ng th√°i
          if (statusText !== "üî¥ ƒêang s·ª≠ d·ª•ng") {
            showWarning('Ch·ªâ b√†n ƒëang s·ª≠ d·ª•ng m·ªõi ƒë∆∞·ª£c thanh to√°n!');
            return;
          }

          fetch("/sale/api/view/" + checked.value)
                  .then((res) => {
                    if (!res.ok) throw new Error("HTTP error " + res.status);
                    return res.json();
                  })
                  .then((data) => {
                    if (!data.menuItems || data.menuItems.length === 0) {
                      showWarning("B√†n ch∆∞a c√≥ th·ª±c ƒë∆°n, kh√¥ng th·ªÉ thanh to√°n!");
                      return;
                    }

                    currentPaymentData = data;

                    // T√™n b√†n
                    document.getElementById("paymentTableName").innerText = data.tableName;

                    // Danh s√°ch m√≥n ƒÉn
                    let itemsHtml = "";
                    data.menuItems.forEach((item) => {
                      itemsHtml += `
                      <tr>
                        <td class="p-1">${item.itemName}</td>
                        <td class="p-1 text-center">${item.quantity}</td>
                        <td class="p-1 text-right">${(item.price * item.quantity || 0).toLocaleString()} ƒë</td>
                      </tr>
                    `;
                    });
                    document.getElementById("paymentItems").innerHTML = itemsHtml;

                    // T·ªïng ti·ªÅn
                    document.getElementById("paymentTotal").innerText = `${(data.totalPrice || 0).toLocaleString()} ƒë`;

                    // Reset input ti·ªÅn kh√°ch ƒë∆∞a v√† ti·ªÅn th·ªëi
                    document.getElementById("customerPay").value = 0;
                    document.getElementById("changeAmount").innerText = "0 ƒë";

                    // Hi·ªán modal
                    document.getElementById("paymentModal").classList.remove("hidden");

                    // N√∫t x√°c nh·∫≠n thanh to√°n
                    document.getElementById("confirmPaymentBtn").onclick = function () {
                      submitPayment(data.tableId);
                    };
                  })
                  .catch((err) => {
                    console.error(err);
                    showError("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu b√†n!");
                  });
        }

        function calculateChange() {
          const customerPay = parseInt(document.getElementById("customerPay").value) || 0;
          const total = currentPaymentData?.totalPrice || 0;
          const change = customerPay - total;
          document.getElementById("changeAmount").innerText = `${change > 0 ? change.toLocaleString() : 0} ƒë`;
        }

        function submitPayment(tableId) {
          const autoEmpty = document.getElementById("autoSetEmpty").checked ? "true" : "false";
          const customerPay = parseInt(document.getElementById("customerPay").value) || 0;

          const total = currentPaymentData?.totalPrice || 0;

          if (customerPay < total) {
            showWarning("S·ªë ti·ªÅn kh√°ch ƒë∆∞a kh√¥ng ƒë·ªß ƒë·ªÉ thanh to√°n!");
            return;
          }

          // L·∫•y CSRF token (n·∫øu d√πng Thymeleaf + Spring Security)
          const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
          const csrfParam = document.querySelector('meta[name="_csrf_parameter"]')?.getAttribute("content");

          const form = document.createElement("form");
          form.method = "post";
          form.action = "/sale/payment";
          form.style.display = "none";

          form.innerHTML = `
          <input name="tableId" value="${tableId}" />
          ${csrfToken && csrfParam ? `<input name="${csrfParam}" value="${csrfToken}" />` : ''}
        `;

          document.body.appendChild(form);
          form.submit();
        }


        function closePaymentModal() {
          document.getElementById("paymentModal").classList.add("hidden");
        }

        function printReceipt() {
          if (!currentPaymentData) {
            showWarning("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ in!");
            return;
          }
          // V√≠ d·ª•: M·ªü c·ª≠a s·ªï in ƒë∆°n gi·∫£n
          let content = `<h3>H√≥a ƒë∆°n - ${currentPaymentData.tableName}</h3><ul>`;
          currentPaymentData.menuItems.forEach(item => {
            content += `<li>${item.itemName} x${item.quantity} - ${(item.price || 0).toLocaleString()} ƒë</li>`;
          });
          content += `</ul><p><strong>T·ªïng ti·ªÅn:</strong> ${(currentPaymentData.totalPrice || 0).toLocaleString()} ƒë</p>`;
          const win = window.open('', '_blank');
          win.document.write(content);
          win.print();
        }

        // chuy·ªÉn b√†n
        function openTransferModalFromSelection() {
          const checked = document.querySelector('input[name="selectedTable"]:checked');
          if (!checked) {
            showWarning('Vui l√≤ng ch·ªçn m·ªôt b√†n ƒë·ªÉ chuy·ªÉn!');
            return;
          }
          const tableId = checked.value;
          const tableDiv = checked.closest('div');
          const tableName = tableDiv.querySelector('label').innerText;

          const statusSpan = tableDiv.querySelector('.text-xs span');
          const statusText = statusSpan ? statusSpan.textContent.trim() : '';

          // Ki·ªÉm tra tr·∫°ng th√°i
          if (statusText == "üü¢ Tr·ªëng") {
            showWarning('Ch·ªâ c√≥ b√†n ƒë√£ ƒë·∫∑t tr∆∞·ªõc ho·∫∑c b√†n ƒëang s·ª≠ d·ª•ng m·ªõi ƒë∆∞·ª£c chuy·ªÉn');
            return;
          }

          openTransferModal(tableId, tableName);
        }

        function openTransferModal(fromTableId, fromTableName) {
          document.getElementById('fromTableId').value = fromTableId;
          document.getElementById('fromTableName').innerText = fromTableName;
          document.getElementById('toTableSelect').value = '';
          document.getElementById('transferError').innerText = '';
          document.getElementById('transferModal').classList.remove('hidden');
        }

        function closeTransferModal() {
          document.getElementById('transferModal').classList.add('hidden');
        }

        function submitTransferForm() {
          const toTableId = document.getElementById('toTableSelect').value;
          if (!toTableId) {
            document.getElementById('transferError').innerText = 'Vui l√≤ng ch·ªçn b√†n ƒë√≠ch!';
            return;
          }
          document.getElementById('transferForm').submit();
        }


        // g·ªôp b√†n
        function openModalMergeTable() {
          document.getElementById("mergeTableModal").classList.remove("hidden");
        }

        function closeModalMergeTable() {
          document.getElementById("mergeTableModal").classList.add("hidden");
        }

        document.getElementById("mergeTableForm")?.addEventListener("submit", function(event) {
          const sources = Array.from(document.querySelectorAll('.merge-source:checked')).map(cb => cb.value);
          const target = document.querySelector('.merge-target:checked')?.value;

          if (sources.length === 0 || !target) {
            event.preventDefault();
            showWarning("Vui l√≤ng ch·ªçn c√°c b√†n c·∫ßn g·ªôp v√† b√†n g·ªôp ƒë·∫øn!");
            return;
          }

          if (sources.length == 1) {
            event.preventDefault();
            showWarning("N·∫øu ch·ªçn m·ªôt b√†n g·ªôp th√¨ vui l√≤ng th·ª±c hi·ªán ch·ª©c nƒÉng chuy·ªÉn b√†n");
            return;
          }
        });
      </script>
    </div>
  </body>
</html>
