<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout}"
>
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω b√°n h√†ng</title>
  </head>
  <body>
    <div layout:fragment="content">
      <div class="space-y-6">
        <!-- Ti√™u ƒë·ªÅ -->
        <h2 class="text-2xl font-bold text-[#4e342e]">üìã S∆° ƒë·ªì b√†n</h2>

        <!-- Grid b√†n -->
        <div class="grid grid-cols-5 gap-4 w-fit mx-auto">
          <div
            th:each="table : ${tables}"
            class="flex flex-col items-center justify-center aspect-square rounded-xl font-semibold text-center shadow-md w-24 p-2 transition duration-200"
            th:classappend="${table.status == 'AVAILABLE'}
             ? 'bg-green-100 text-green-800 hover:bg-green-200 cursor-pointer'
             : (${table.status == 'RESERVED'}
                ? 'bg-yellow-100 text-yellow-800'
                : 'bg-gray-300 text-gray-700 hover:bg-gray-400')"
          >
            <!-- Checkbox lu√¥n ch·ªçn ƒë∆∞·ª£c -->
            <input
              type="checkbox"
              th:id="'table-' + ${table.id}"
              th:value="${table.id}"
              class="mb-1 table-checkbox"
              name="selectedTable"
            />

            <!-- T√™n b√†n -->
            <label
              th:for="'table-' + ${table.id}"
              th:text="${table.tableName}"
            ></label>

            <!-- Tr·∫°ng th√°i c√≥ icon -->
            <span class="text-xs mt-1 flex items-center gap-1">
              <span th:if="${table.status == 'AVAILABLE'}">üü¢ Tr·ªëng</span>
              <span th:if="${table.status == 'OCCUPIED'}">üî¥ ƒêang s·ª≠ d·ª•ng</span>
              <span th:if="${table.status == 'RESERVED'}">üü° ƒê·∫∑t tr∆∞·ªõc</span>
            </span>
          </div>
        </div>

        <!-- C√°c n√∫t thao t√°c -->
        <div class="flex flex-wrap gap-3 justify-center mt-6">
          <a
            th:href="@{/sale/create}"
            class="inline-block bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            ‚ûï Th√™m b√†n
          </a>
          <button
            type="button"
            onclick="showSelectedTables()"
            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          >
            üëÅÔ∏è Xem b√†n
          </button>
          <button
            class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600"
          >
            Chuy·ªÉn b√†n
          </button>
          <button
            class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600"
          >
            T√°ch b√†n
          </button>
          <button
            class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600"
          >
            G·ªôp b√†n
          </button>
          <form id="cancelForm" th:action="@{/sale/cancel}" method="post" style="display:inline;">
            <input type="hidden" name="tableId" id="cancelTableId" />
            <button
                    type="button"
                    class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                    onclick="cancelSelectedTable()"
            >
              H·ªßy b√†n
            </button>
          </form>
          <button
                  type="button"
                  class="bg-blue-600 text-white px-4 py-2 rounded"
                  onclick="redirectToReservationForm()"
          >
            ƒê·∫∑t b√†n
          </button>
        </div>

        <!-- Menu, Thanh to√°n, In -->
        <div class="grid grid-cols-3 gap-4 max-w-4xl mx-auto mt-4">
          <button
                  type="button"
                  class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                  onclick="openMenuModal()"
          >
            Ch·ªçn th·ª±c ƒë∆°n
          </button>
          <button
                  type="button"
                  class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700"
                  onclick="confirmPayment()"
          >
            üí≥ Thanh to√°n
          </button>
          <button
            class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
          >
            üñ®Ô∏è In h√≥a ƒë∆°n
          </button>
        </div>
      </div>

      <!-- Modal hi·ªÉn th·ªã chi ti·∫øt b√†n -->
      <div
        id="detailModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
      >
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
          <h2 class="text-xl font-bold mb-4">ü™ë Chi ti·∫øt b√†n</h2>
          <div id="modalContent" class="space-y-2">
            <p><strong>T√™n b√†n:</strong> <span id="tableName"></span></p>
            <p><strong>Tr·∫°ng th√°i:</strong> <span id="tableStatus"></span></p>
          </div>
          <button
            onclick="closeDetailModal()"
            class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
          >
            ‚úñÔ∏è
          </button>
        </div>
      </div>

      <!-- Modal ch·ªçn th·ª±c ƒë∆°n -->
      <div id="menuModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
          <button onclick="closeMenuModal()" class="absolute top-2 right-2 text-gray-400 hover:text-black text-2xl">&times;</button>
          <h2 class="text-xl font-bold mb-4 text-green-700">Ch·ªçn th·ª±c ƒë∆°n cho b√†n</h2>
          <form id="menuForm" th:action="@{/sale/select-menu}" method="post">
            <input type="hidden" name="tableId" id="menuTableId" />
            <div class="max-h-60 overflow-y-auto mb-4 space-y-2">
              <div th:each="menu : ${menus}" class="flex items-center gap-2">
                <input
                        type="checkbox"
                        class="menu-checkbox"
                        name="menuIds"
                        th:value="${menu.id}"
                />
                <span th:text="${menu.itemName}" class="flex-1"></span>
                <div class="flex items-center gap-1">
                  <button type="button"
                          class="decrement bg-gray-200 px-2 rounded disabled:opacity-50"
                          disabled>-</button>
                  <input type="number"
                         name="quantities"
                         min="1"
                         value="1"
                         class="menu-quantity w-12 text-center border rounded py-0.5"
                         disabled />
                  <button type="button"
                          class="increment bg-gray-200 px-2 rounded disabled:opacity-50"
                          disabled>+</button>
                </div>
              </div>
            </div>

            <div id="menuModalMsg" class="text-red-500 text-sm mb-2"></div>
            <button type="button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded" onclick="submitMenuForm()">L∆∞u th·ª±c ƒë∆°n</button>
          </form>
        </div>
      </div>


      <!-- Modal thanh to√°n -->
      <div
              id="paymentModal"
              class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
      >
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
          <h2 class="text-xl font-bold mb-4 text-teal-700">üí≥ X√°c nh·∫≠n thanh to√°n</h2>
          <div id="paymentModalContent" class="space-y-2"></div>
          <div class="flex gap-3 mt-4">
            <button
                    id="confirmPaymentBtn"
                    class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded w-full"
            >
              X√°c nh·∫≠n thanh to√°n
            </button>
            <button
                    onclick="closePaymentModal()"
                    class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded w-full"
            >
              H·ªßy
            </button>
          </div>
          <button
                  onclick="closePaymentModal()"
                  class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
          >
            ‚úñÔ∏è
          </button>
        </div>

        <form id="paymentForm" th:action="@{/sale/payment}" method="post" style="display:none;">
          <input type="hidden" name="tableId" />
        </form>
      </div>

      <script>
        // xem th√¥ng tin b√†n
        // Ch·ªâ cho ph√©p ch·ªçn 1 checkbox b√†n
        document.querySelectorAll("input.table-checkbox").forEach((cb) => {
          cb.addEventListener("change", function () {
            if (this.checked) {
              document
                      .querySelectorAll("input.table-checkbox")
                      .forEach((other) => {
                        if (other !== this) other.checked = false;
                      });
            }
          });
        });


        function showSelectedTables() {
          const checkbox = document.querySelector("input[type=checkbox]:checked");
          if (!checkbox) {
            showWarning("Vui l√≤ng ch·ªçn m·ªôt b√†n.");
            return;
          }

          const tableDiv = checkbox.closest("div");
          const statusSpan = tableDiv.querySelector(".text-xs span");
          const statusText = statusSpan ? statusSpan.textContent.trim() : "";

          if (statusText === "üü¢ Tr·ªëng") {
            showWarning("B√†n ƒëang tr·ªëng, ch∆∞a c√≥ d·ªØ li·ªáu chi ti·∫øt ƒë·ªÉ xem!");
            return;
          }
          const id = checkbox.value;
          fetch("/sale/api/view/" + id)
                  .then((res) => {
                    if (!res.ok) throw new Error("HTTP error " + res.status);
                    return res.json();
                  })
                  .then((data) => {
                    console.log("data", data);
                    const modalContent = document.getElementById("modalContent");

                    let statusText = "";
                    if (data.status === "AVAILABLE") {
                      statusText = "üü¢ Tr·ªëng";
                    } else if (data.status === "RESERVED") {
                      statusText = "üü° ƒê·∫∑t tr∆∞·ªõc";
                    } else {
                      statusText = "üî¥ ƒêang s·ª≠ d·ª•ng";
                    }

                    let menuHtml = "";
                    if (data.menuItems && data.menuItems.length > 0) {
                      menuHtml = "<ul class='list-disc ml-5'>";
                      data.menuItems.forEach((item) => {
                        menuHtml += `<li>${item.itemName} - SL: ${item.quantity} - Gi√°: ${
                                item.price
                                        ? item.price.toLocaleString()
                                        : "0"
                        }ƒë</li>`;
                      });
                      menuHtml += "</ul>";
                      // Th√™m t·ªïng ti·ªÅn
                      menuHtml += `<p class="mt-2"><strong>T·ªïng ti·ªÅn:</strong> ${
                              data.totalPrice ? data.totalPrice.toLocaleString() : "0"
                      } ƒë</p>`;
                    } else {
                      menuHtml = "<em>Ch∆∞a c√≥ th·ª±c ƒë∆°n</em>";
                    }

                    const customerInfo = data.customerName
                            ? `<p><strong>Kh√°ch h√†ng:</strong> ${data.customerName} (${
                                    data.customerPhone || "N/A"
                            })</p>`
                            : "";

                    const reservationDate = data.reservationDate
                            ? `<p><strong>Ng√†y ƒë·∫∑t:</strong> ${new Date(
                                    data.reservationDate
                            ).toLocaleString()}</p>`
                            : "";

                    modalContent.innerHTML = `
                  <p><strong>T√™n b√†n:</strong> ${data.tableName}</p>
                  <p><strong>Tr·∫°ng th√°i:</strong> ${statusText}</p>
                  ${customerInfo}
                  ${reservationDate}
                  <p><strong>Th·ª±c ƒë∆°n ƒë√£ ch·ªçn:</strong></p>
                  ${menuHtml}
                `;
                    document.getElementById("detailModal").classList.remove("hidden");
                  })
                  .catch((err) => {
                    console.error(err);
                    showError("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu b√†n!");
                  });
        }


        function closeDetailModal() {
          document.getElementById("detailModal").classList.add("hidden");
        }


        // ƒë·∫∑t b√†n
        function redirectToReservationForm() {
          const checked = document.querySelector('input[name="selectedTable"]:checked');
          if (!checked) {
            showWarning('Vui l√≤ng ch·ªçn m·ªôt b√†n!');
            return;
          }
          // L·∫•y tr·∫°ng th√°i b√†n t·ª´ DOM
          const tableDiv = checked.closest('div');
          const statusSpan = tableDiv.querySelector('.text-xs span');
          const statusText = statusSpan ? statusSpan.textContent.trim() : '';
          if (statusText !== "üü¢ Tr·ªëng") {
            showWarning('Ch·ªâ ƒë∆∞·ª£c ƒë·∫∑t b√†n khi b√†n ƒëang tr·ªëng!');
            return;
          }
          window.location.href = '/sale/reservation?tableId=' + checked.value;
        }

        // h·ªßy b√†n
        function cancelSelectedTable() {
          const checked = document.querySelector('input[name="selectedTable"]:checked');
          if (!checked) {
            showWarning('Vui l√≤ng ch·ªçn m·ªôt b√†n ƒë·ªÉ h·ªßy!');
            return;
          }
          // L·∫•y tr·∫°ng th√°i b√†n t·ª´ DOM
          const tableDiv = checked.closest('div');
          const statusSpan = tableDiv.querySelector('.text-xs span');
          const statusText = statusSpan ? statusSpan.textContent.trim() : '';
          if (statusText === "üü¢ Tr·ªëng" || statusText === "üî¥ ƒêang s·ª≠ d·ª•ng") {
            showWarning('Ch·ªâ c√≥ b√†n ƒë·∫∑t tr∆∞·ªõc m·ªõi ƒë∆∞·ª£c h·ªßy!');
            return;
          }
          showConfirm(
                  'X√°c nh·∫≠n h·ªßy b√†n',
                  'B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy b√†n n√†y?',
                  function() {
                    document.getElementById('cancelTableId').value = checked.value;
                    document.getElementById('cancelForm').submit();
                  }
          );
        }

        //ch·ªçn th·ª±c ƒë∆°n
        function openMenuModal() {
          const checked = document.querySelector('input[name="selectedTable"]:checked');
          if (!checked) {
            showWarning('Vui l√≤ng ch·ªçn m·ªôt b√†n!');
            return;
          }

          document.getElementById('menuTableId').value = checked.value;
          document.querySelectorAll('#menuModal input[type=checkbox]').forEach(cb => cb.checked = false);
          document.getElementById('menuModalMsg').innerText = '';
          document.getElementById('menuModal').classList.remove('hidden');
        }

        function closeMenuModal() {
          document.getElementById('menuModal').classList.add('hidden');
        }

        function submitMenuForm() {
          const checkedMenus = document.querySelectorAll('#menuModal input[name="menuIds"]:checked');
          if (checkedMenus.length === 0) {
            document.getElementById('menuModalMsg').innerText = 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt th·ª±c ƒë∆°n!';
            return;
          }
          let isValid = true;
          checkedMenus.forEach(cb => {
            const qtyInput = cb.parentElement.querySelector('.menu-quantity');
            const val = parseInt(qtyInput.value);
            if (isNaN(val) || val < 1) {
              isValid = false;
            }
          });
          if (!isValid) {
            document.getElementById('menuModalMsg').innerText = 'S·ªë l∆∞·ª£ng ph·∫£i t·ª´ 1 tr·ªü l√™n!';
            return;
          }
          document.getElementById('menuForm').submit();
        }

        // B·∫≠t/t·∫Øt input v√† n√∫t + -
        document.querySelectorAll('#menuModal .menu-checkbox').forEach(cb => {
          cb.addEventListener('change', function() {
            const quantityInput = this.parentElement.querySelector('.menu-quantity');
            const decrementBtn = this.parentElement.querySelector('.decrement');
            const incrementBtn = this.parentElement.querySelector('.increment');
            const enabled = this.checked;
            quantityInput.disabled = !enabled;
            decrementBtn.disabled = !enabled;
            incrementBtn.disabled = !enabled;
            if (enabled && quantityInput.value.trim() === '') {
              quantityInput.value = '1';
            }
          });
        });

        // N√∫t tƒÉng
        document.querySelectorAll('#menuModal .increment').forEach(btn => {
          btn.addEventListener('click', function() {
            const input = this.parentElement.querySelector('.menu-quantity');
            let val = parseInt(input.value) || 1;
            input.value = val + 1;
          });
        });

        // N√∫t gi·∫£m
        document.querySelectorAll('#menuModal .decrement').forEach(btn => {
          btn.addEventListener('click', function() {
            const input = this.parentElement.querySelector('.menu-quantity');
            let val = parseInt(input.value) || 1;
            if (val > 1) input.value = val - 1;
          });
        });

        //thanh to√°n
        function submitPayment(tableId) {
          let form = document.getElementById('paymentForm');
          if (!form) {
            form = document.createElement('form');
            form.method = 'post';
            form.action = '/sale/payment';
            form.style.display = 'none';
            form.innerHTML = `<input name="tableId" value="${tableId}"/>`;
            document.body.appendChild(form);
          } else {
            form.querySelector('input[name="tableId"]').value = tableId;
          }
          form.submit();
        }

        function confirmPayment() {
          const checked = document.querySelector('input[name="selectedTable"]:checked');
          if (!checked) {
            showWarning('Vui l√≤ng ch·ªçn m·ªôt b√†n ƒë·ªÉ thanh to√°n!');
            return;
          }
          const tableDiv = checked.closest('div');
          const statusSpan = tableDiv.querySelector('.text-xs span');
          const statusText = statusSpan ? statusSpan.textContent.trim() : '';
          if (statusText === "üü¢ Tr·ªëng") {
            showWarning('B√†n tr·ªëng kh√¥ng th·ªÉ thanh to√°n!');
            return;
          }
          // L·∫•y chi ti·∫øt b√†n qua API
          fetch("/sale/api/view/" + checked.value)
                  .then((res) => {
                    if (!res.ok) throw new Error("HTTP error " + res.status);
                    return res.json();
                  })
                  .then((data) => {
                    let statusText = "";
                    if (data.status === "AVAILABLE") {
                      statusText = "üü¢ Tr·ªëng";
                    } else if (data.status === "RESERVED") {
                      statusText = "üü° ƒê·∫∑t tr∆∞·ªõc";
                    } else {
                      statusText = "üî¥ ƒêang s·ª≠ d·ª•ng";
                    }

                    let menuHtml = "";
                    if (data.menuItems && data.menuItems.length > 0) {
                      menuHtml = "<ul class='list-disc ml-5'>";
                      data.menuItems.forEach((item) => {
                        menuHtml += `<li>${item.itemName} - SL: ${item.quantity} - Gi√°: ${
                                item.price ? item.price.toLocaleString() : "0"
                        }ƒë</li>`;
                      });
                      menuHtml += "</ul>";
                      menuHtml += `<p class="mt-2"><strong>T·ªïng ti·ªÅn:</strong> ${
                              data.totalPrice ? data.totalPrice.toLocaleString() : "0"
                      } ƒë</p>`;
                    } else {
                      menuHtml = "<em>Ch∆∞a c√≥ th·ª±c ƒë∆°n</em>";
                    }

                    const customerInfo = data.customerName
                            ? `<p><strong>Kh√°ch h√†ng:</strong> ${data.customerName} (${
                                    data.customerPhone || "N/A"
                            })</p>`
                            : "";

                    const reservationDate = data.reservationDate
                            ? `<p><strong>Ng√†y ƒë·∫∑t:</strong> ${new Date(
                                    data.reservationDate
                            ).toLocaleString()}</p>`
                            : "";

                    document.getElementById("paymentModalContent").innerHTML = `
                    <p><strong>T√™n b√†n:</strong> ${data.tableName}</p>
                    <p><strong>Tr·∫°ng th√°i:</strong> ${statusText}</p>
                    ${customerInfo}
                    ${reservationDate}
                    <p><strong>Th·ª±c ƒë∆°n ƒë√£ ch·ªçn:</strong></p>
                    ${menuHtml}
                  `;
                    document.getElementById("paymentModal").classList.remove("hidden");

                    // G√°n s·ª± ki·ªán x√°c nh·∫≠n thanh to√°n
                    document.getElementById("confirmPaymentBtn").onclick = function () {
                      submitPayment(data.id); // data.id l√† id c·ªßa b√†n ho·∫∑c reservation
                    };
                  })
                  .catch((err) => {
                    showError("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu b√†n!");
                  });
        }

        function closePaymentModal() {
          document.getElementById("paymentModal").classList.add("hidden");
        }

      </script>
    </div>
  </body>
</html>
