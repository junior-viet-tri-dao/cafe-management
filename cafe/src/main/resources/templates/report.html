<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report</title>
    <!-- Thêm Tailwind CSS CDN và font Inter để đồng bộ với các trang khác -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Sử dụng font Inter cho toàn bộ trang */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Các kiểu CSS cũ đã được chuyển đổi thành lớp Tailwind, nhưng giữ lại một số để đảm bảo tính năng sắp xếp của bảng */
        .sortable-header {
            cursor: pointer;
            padding-right: 20px; /* Tạo khoảng trống cho mũi tên */
            position: relative;
        }
        .sort-arrow {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: #888;
        }
    </style>
</head>
<body>

<div layout:fragment="content" class="p-4 md:p-8 bg-gray-50 min-h-screen">

    <div class="max-w-7xl mx-auto space-y-6">

        <!-- Form chọn loại báo cáo và ngày -->
        <form id="reportForm" action="/report" method="GET">
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                <h3 class="text-xl font-bold text-gray-700">Lựa chọn báo cáo</h3>
                <div class="flex flex-wrap gap-4 radio-group">
                    <label class="flex items-center"><input type="radio" name="reportType" value="all" class="mr-2" checked>Tất cả</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="import-export" class="mr-2">Nhập-xuất</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="import" class="mr-2">Nhập</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="sales" class="mr-2">Bán hàng</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="salary" class="mr-2">Lương</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="employee" class="mr-2">TT nhân viên</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="export" class="mr-2">Xuất</label>
                    <label class="flex items-center"><input type="radio" name="reportType" value="other-fees" class="mr-2">Phí khác</label>
                </div>

                <div class="flex flex-col md:flex-row items-center gap-4 date-selection">
                    <div class="flex items-center w-full md:w-auto">
                        <label for="fromDate" class="shrink-0 mr-2">Từ ngày</label>
                        <input type="date" id="fromDate" name="fromDate" value="2014-12-23"
                               class="w-full md:w-auto p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex items-center w-full md:w-auto">
                        <label for="toDate" class="shrink-0 mr-2">đến ngày</label>
                        <input type="date" id="toDate" name="toDate" value="2014-12-25"
                               class="w-full md:w-auto p-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="submit"
                            class="w-full md:w-auto px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow-sm hover:bg-green-700 transition">
                        Xem
                    </button>
                </div>
            </div>
        </form>

        <!-- Bảng kết quả báo cáo, sử dụng overflow-x-auto để cuộn ngang trên mobile -->
        <div class="report-results overflow-x-auto">
            <table class="report-table w-full border-collapse bg-white shadow-md rounded-lg" id="reportDataTable">
                <thead class="bg-gray-100">
                <tr>
                    <th class="sortable-header p-4 border text-left font-semibold" data-sort-by="date">Ngày <span class="sort-arrow"></span></th>
                    <th class="sortable-header p-4 border text-left font-semibold" data-sort-by="thu">Thu <span class="sort-arrow"></span></th>
                    <th class="sortable-header p-4 border text-left font-semibold" data-sort-by="chi">Chi <span class="sort-arrow"></span></th>
                </tr>
                </thead>
                <tbody>

                <tr th:each="report : ${reports}">
                    <td th:text="${report.date != null ? #temporals.format(report.date, 'dd/MM/yyyy') : ''}" class="p-4 border"></td>
                    <td th:text="${report.revenue != null ? #numbers.formatDecimal(report.revenue, 0, 'COMMA', 0, 'POINT') + ' đ' : '0 đ'}" class="p-4 border text-right"></td>
                    <td th:text="${report.expense != null ? #numbers.formatDecimal(report.expense, 0, 'COMMA', 0, 'POINT') + ' đ' : '0 đ'}" class="p-4 border text-right"></td>
                </tr>

                </tbody>
            </table>
        </div>

<!--        &lt;!&ndash; Các nút hành động (Xuất file, In file) &ndash;&gt;-->
<!--        <div class="flex flex-col md:flex-row justify-between gap-6 action-group">-->
<!--            <div class="bg-white p-6 rounded-lg shadow-md w-full md:w-1/2">-->
<!--                <h3 class="text-lg font-bold mb-4">Xuất file</h3>-->
<!--                <form id="exportForm" action="/api/report/export" method="POST" class="space-y-3">-->
<!--                    <label class="flex items-center"><input type="radio" name="exportFormat" value="txt" class="mr-2" checked> .txt - Text File</label>-->
<!--                    <label class="flex items-center"><input type="radio" name="exportFormat" value="xls" class="mr-2"> .xls - Excel File</label>-->
<!--                    <label class="flex items-center"><input type="radio" name="exportFormat" value="sql" class="mr-2"> .sql - SQL File</label>-->
<!--                    <button type="submit"-->
<!--                            class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 transition">-->
<!--                        Xuất file-->
<!--                    </button>-->
<!--                </form>-->
<!--            </div>-->

<!--            <div class="bg-white p-6 rounded-lg shadow-md w-full md:w-1/2">-->
<!--                <h3 class="text-lg font-bold mb-4">In file</h3>-->
<!--                <form id="printForm" action="/api/report/print" method="POST" class="space-y-3">-->
<!--                    <div class="form-field">-->
<!--                        <label for="paperSize" class="block mb-1">Khổ giấy:</label>-->
<!--                        <select id="paperSize" name="paperSize"-->
<!--                                class="w-full p-2 border border-gray-300 rounded-md">-->
<!--                            <option value="A4">A4</option>-->
<!--                            <option value="A3">A3</option>-->
<!--                            <option value="Letter">Letter</option>-->
<!--                        </select>-->
<!--                    </div>-->
<!--                    <div class="form-field">-->
<!--                        <label for="printer" class="block mb-1">Máy in:</label>-->
<!--                        <select id="printer" name="printer"-->
<!--                                class="w-full p-2 border border-gray-300 rounded-md">-->
<!--                            <option value="Hp Laser">Hp Laser</option>-->
<!--                            <option value="Epson Inkjet">Epson Inkjet</option>-->
<!--                            <option value="Canon Pixma">Canon Pixma</option>-->
<!--                        </select>-->
<!--                    </div>-->
<!--                    <div class="form-field">-->
<!--                        <label for="copies" class="block mb-1">Số lượng:</label>-->
<!--                        <input type="number" id="copies" name="copies" value="3" min="1"-->
<!--                               class="w-full p-2 border border-gray-300 rounded-md">-->
<!--                    </div>-->
<!--                    <button type="submit"-->
<!--                            class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 transition">-->
<!--                        In-->
<!--                    </button>-->
<!--                </form>-->
<!--            </div>-->
<!--        </div>-->
    </div>
</div>

<script>
    // JavaScript for handling form submissions and (optional) basic sorting
    document.addEventListener('DOMContentLoaded', () => {
        const reportForm = document.getElementById('reportForm');
        const exportForm = document.getElementById('exportForm');
        const printForm = document.getElementById('printForm');
        const reportTable = document.getElementById('reportDataTable');
        const headerCells = reportTable.querySelectorAll('th.sortable-header');

        let currentSortColumn = null;
        let currentSortDirection = 'asc'; // 'asc' for ascending, 'desc' for descending

        // Function to get cell value for sorting
        function getCellValue(row, columnIndex, sortBy) {
            const cells = Array.from(row.querySelectorAll('td'));
            const cell = cells[columnIndex];

            if (!cell) return null; // Handle cases where cell might not exist for some rows

            // For numeric columns (Thu, Chi)
            if (sortBy === 'thu' || sortBy === 'chi') {
                // Get data-value for raw number, otherwise parse text content
                return parseFloat(cell.dataset.value || cell.textContent.replace(/\./g, '').replace(',', '.'));
            }
            // For date column (Ngày)
            if (sortBy === 'date') {
                // Assuming date format DD/MM/YYYY for display, convert to YYYY-MM-DD for sorting
                const dateParts = cell.textContent.trim().split('/');
                if (dateParts.length === 3) {
                    return new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`);
                }
                return null; // Invalid date format
            }
            // Default to text content for other columns
            return cell.textContent.trim().toLowerCase();
        }

        // Function to sort the table
        function sortTable(columnIndex, direction, sortBy) {
            const tbody = reportTable.querySelector('tbody');
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((rowA, rowB) => {
                const valueA = getCellValue(rowA, columnIndex, sortBy);
                const valueB = getCellValue(rowB, columnIndex, sortBy);

                if (valueA === null || valueB === null) {
                    // Handle cases where values might be invalid or missing
                    return 0;
                }

                if (valueA < valueB) {
                    return direction === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return direction === 'asc' ? 1 : -1;
                }
                return 0;
            });

            // Remove existing rows and append sorted rows
            const fragment = document.createDocumentFragment();
            rows.forEach(row => fragment.appendChild(row));
            tbody.innerHTML = ''; // Clear existing rows
            tbody.appendChild(fragment);
        }

        // Add click event listeners to sortable headers
        headerCells.forEach((header, index) => {
            header.addEventListener('click', () => {
                const sortBy = header.dataset.sortBy;
                let direction;

                // If clicking the same column, toggle sort direction
                if (currentSortColumn === sortBy) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // If clicking a new column, reset to ascending
                    currentSortColumn = sortBy;
                    currentSortDirection = 'asc';
                }
                direction = currentSortDirection;

                // Clear sort arrows from all headers
                document.querySelectorAll('.sort-arrow').forEach(arrow => arrow.textContent = '');

                // Update the sort arrow for the clicked header
                const sortArrow = header.querySelector('.sort-arrow');
                if (direction === 'asc') {
                    sortArrow.textContent = '▲';
                } else {
                    sortArrow.textContent = '▼';
                }

                sortTable(index, direction, sortBy);
            });
        });


        // Handle "Xem" button click (Report Form Submission)
        reportForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData(this);
            const params = new URLSearchParams();
            for (const pair of formData) {
                params.append(pair[0], pair[1]);
            }

            // Construct the URL with query parameters
            const url = `${this.action}?${params.toString()}`;
            console.log('Sending GET request to Backend (Xem):', url);

            // Here you would typically use fetch API to send the request
            // fetch(url)
            //     .then(response => response.json()) // or .text() depending on your backend
            //     .then(data => {
            //         console.log('Backend response (Xem):', data);
            //         // Update the report table with received data
            //         // For this example, we'll just log
            //     })
            //     .catch(error => {
            //         console.error('Error fetching report:', error);
            //     });

            alert('Request "Xem" đã được gửi đến Backend. Xem console để biết chi tiết.');
        });

        // Handle "Xuất file" button click (Export Form Submission)
        exportForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData(this);
            const exportFormat = formData.get('exportFormat'); // e.g., 'txt', 'xls', 'sql'

            // You might want to get the current report parameters (date range, report type)
            // from the main reportForm if the backend needs them for export.
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            const exportData = {
                format: exportFormat,
                reportType: reportType,
                fromDate: fromDate,
                toDate: toDate
            };

            // Construct the URL and send POST request
            const url = this.action; // /api/report/export
            console.log('Sending POST request to Backend (Xuất file):', url, 'with data:', exportData);

            // fetch(url, {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //     },
            //     body: JSON.stringify(exportData),
            // })
            // .then(response => {
            //     if (response.ok) {
            //         // For file downloads, you might handle it differently, e.g.,
            //         // response.blob().then(blob => {
            //         //    const url = window.URL.createObjectURL(blob);
            //         //    const a = document.createElement('a');
            //         //    a.href = url;
            //         //    a.download = `report.${exportFormat}`;
            //         //    document.body.appendChild(a);
            //         //    a.click();
            //         //    a.remove();
            //         //    window.URL.revokeObjectURL(url);
            //         // });
            //         console.log('File export initiated successfully!');
            //     } else {
            //         console.error('File export failed!');
            //     }
            // })
            // .catch(error => {
            //     console.error('Error during file export:', error);
            // });

            alert(`Request "Xuất file (${exportFormat})" đã được gửi đến Backend. Xem console để biết chi tiết.`);
        });

        // Handle "In" button click (Print Form Submission)
        printForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData(this);
            const paperSize = formData.get('paperSize');
            const printer = formData.get('printer');
            const copies = formData.get('copies');

            // Again, you might want to send current report parameters
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            const printData = {
                paperSize: paperSize,
                printer: printer,
                copies: parseInt(copies, 10), // Ensure copies is an integer
                reportType: reportType,
                fromDate: fromDate,
                toDate: toDate
            };

            const url = this.action; // /api/report/print
            console.log('Sending POST request to Backend (In):', url, 'with data:', printData);

            // fetch(url, {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //     },
            //     body: JSON.stringify(printData),
            // })
            // .then(response => {
            //     if (response.ok) {
            //         console.log('Print request sent successfully!');
            //     } else {
            //         console.error('Print request failed!');
            //     }
            // })
            // .catch(error => {
            //     console.error('Error sending print request:', error);
            // });

            alert('Request "In" đã được gửi đến Backend. Xem console để biết chi tiết.');
        });
    });
</script>

</body>
</html>
