<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout}">
<head>
    <title>B√°o c√°o th·ªëng k√™</title>

    <!-- Th√™m v√†o trong <head> n·∫øu ch∆∞a c√≥ Bootstrap JS -->
    <script>
        function validateForm() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;
            const now = new Date().toISOString().split("T")[0];

            if (start > end) {
                alert("‚ö†Ô∏è T·ª´ ng√†y ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng ƒë·∫øn ng√†y.");
                return false;
            }

            if (start > now || end > now) {
                alert("‚ö†Ô∏è Ng√†y kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ng√†y hi·ªán t·∫°i.");
                return false;
            }

            return true;
        }
    </script>

</head>

<body>
<main layout:fragment="content">
    <div class="container mt-5">
        <h2 class="mb-4 text-primary fw-bold">üìà B√°o c√°o th·ªëng k√™</h2>

        <!-- FORM L·ªåC TRONG CARD -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="get" action="/report" onsubmit="return validateForm()">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="start" class="form-label">T·ª´ ng√†y:</label>
                            <input type="date" name="startDate" id="start" class="form-control" required
                                   th:value="${startDate}">
                        </div>
                        <div class="col-md-4">
                            <label for="end" class="form-label">ƒê·∫øn ng√†y:</label>
                            <input type="date" name="endDate" id="end" class="form-control" required
                                   th:value="${endDate}">
                        </div>
                        <div class="col-md-4">
                            <label for="type" class="form-label">Lo·∫°i b√°o c√°o:</label>
                            <select name="type" id="type" class="form-select" required>
                                <option th:value="EMPLOYEE_SALARY" th:selected="${type == 'EMPLOYEE_SALARY'}">üë• Nh√¢n vi√™n & L∆∞∆°ng</option>
                                <option th:value="INVOICE_MONTHLY" th:selected="${type == 'INVOICE_MONTHLY'}">üßæ H√≥a ƒë∆°n theo th√°ng</option>
                                <option th:value="REVENUE_SUMMARY" th:selected="${type == 'REVENUE_SUMMARY'}">üìä Doanh thu</option>
                                <option th:value="EXPENSE_ONLY" th:selected="${type == 'EXPENSE_ONLY'}">üí∏ Chi ti√™u</option>
                                <option th:value="IMPORT_ONLY" th:selected="${type == 'IMPORT_ONLY'}">üìÖ Nh·∫≠p h√†ng</option>
                                <option th:value="EXPORT_ONLY" th:selected="${type == 'EXPORT_ONLY'}">üìÑ Xu·∫•t h√†ng</option>
                                <option th:value="IMPORT_EXPORT" th:selected="${type == 'IMPORT_EXPORT'}">üîÑ Nh·∫≠p - Xu·∫•t</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-4">
                        <button type="submit" class="btn btn-success me-2">üîç Xem b√°o c√°o</button>
                        <a class="btn btn-primary"
                           th:href="@{/report/download(startDate=${startDate}, endDate=${endDate}, type=${type})}"
                           target="_blank">
                            üìÖ T·∫£i PDF
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- TH√îNG B√ÅO L·ªñI -->
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <!-- KH√îNG C√ì D·∫¨ LI·ªÜU -->
        <div th:if="${reportData != null and #lists.isEmpty(reportData)}" class="alert alert-warning">
            ‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.
        </div>

        <!-- K·∫∫T QU·∫¢ HI·ªÇN TH·ªä D·∫¨ LI·ªÜU -->
        <div th:if="${reportData != null and !#lists.isEmpty(reportData)}" class="mt-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">üìå K·∫øt qu·∫£ b√°o c√°o</h5>

                    <div th:switch="${type}">
                        <!-- EMPLOYEE_SALARY -->
                        <div class="table-responsive" th:case="'EMPLOYEE_SALARY'">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                <tr><th>H·ªç t√™n</th><th>SƒêT</th><th>ƒê·ªãa ch·ªâ</th><th>Ch·ª©c v·ª•</th><th>L∆∞∆°ng</th></tr>
                                </thead>
                                <tbody>
                                <tr th:each="e : ${reportData}">
                                    <td th:text="${e.fullName}">T√™n</td>
                                    <td th:text="${e.phoneNumber}">SƒêT</td>
                                    <td th:text="${e.address}">ƒê·ªãa ch·ªâ</td>
                                    <td th:text="${e.position.positionName}">Ch·ª©c v·ª•</td>
                                    <td th:text="${e.position.salary}">L∆∞∆°ng</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- INVOICE_MONTHLY -->
                        <div class="table-responsive" th:case="'INVOICE_MONTHLY'">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                <tr><th>M√£ h√≥a ƒë∆°n</th><th>Ng√†y t·∫°o</th><th>Tr·∫°ng th√°i</th><th>T·ªïng ti·ªÅn</th></tr>
                                </thead>
                                <tbody>
                                <tr th:each="inv : ${reportData}">
                                    <td th:text="${inv.id}">#</td>
                                    <td th:text="${#temporals.format(inv.createdAt, 'dd/MM/yyyy HH:mm')}">Ng√†y</td>
                                    <td th:text="${inv.status}">Tr·∫°ng th√°i</td>
                                    <td th:text="${inv.totalAmount}">T·ªïng</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- REVENUE_SUMMARY -->
                        <div class="table-responsive" th:case="'REVENUE_SUMMARY'">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                <tr><th>Ng√†y</th><th>Doanh thu</th><th>Chi ph√≠</th></tr>
                                </thead>
                                <tbody>
                                <tr th:each="r : ${reportData[0].summaries}">
                                    <td th:text="${r.date}">Ng√†y</td>
                                    <td th:text="${r.income}">Doanh thu</td>
                                    <td th:text="${r.expense}">Chi ph√≠</td>
                                </tr>
                                </tbody>
                                <tfoot class="fw-bold">
                                <tr>
                                    <td>T·ªïng</td>
                                    <td th:text="${reportData[0].totalIncome}">0</td>
                                    <td th:text="${reportData[0].totalExpense}">0</td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- EXPENSE_ONLY -->
                        <div class="table-responsive" th:case="'EXPENSE_ONLY'">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                <tr><th>T√™n chi ti√™u</th><th>Ng√†y</th><th>S·ªë ti·ªÅn</th></tr>
                                </thead>
                                <tbody>
                                <tr th:each="ex : ${reportData}">
                                    <td th:text="${ex.expenseName}">T√™n</td>
                                    <td th:text="${ex.expenseDate}">Ng√†y</td>
                                    <td th:text="${ex.amount}">S·ªë ti·ªÅn</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- IMPORT_ONLY / EXPORT_ONLY gi·ªëng nhau -->
                        <div class="table-responsive" th:case="'IMPORT_ONLY'">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                <tr><th>S·∫£n ph·∫©m</th><th>Ng√†y nh·∫≠p</th><th>S·ªë l∆∞·ª£ng</th><th>T·ªïng ti·ªÅn</th><th>Nh√¢n vi√™n</th></tr>
                                </thead>
                                <tbody>
                                <tr th:each="imp : ${reportData}">
                                    <td th:text="${imp.product.productName}">SP</td>
                                    <td th:text="${imp.importDate}">Ng√†y</td>
                                    <td th:text="${imp.quantity}">SL</td>
                                    <td th:text="${imp.totalAmount}">T·ªïng</td>
                                    <td th:text="${imp.employee.fullName}">NV</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="table-responsive" th:case="'EXPORT_ONLY'">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                <tr><th>S·∫£n ph·∫©m</th><th>Ng√†y xu·∫•t</th><th>S·ªë l∆∞·ª£ng</th><th>T·ªïng ti·ªÅn</th><th>Nh√¢n vi√™n</th></tr>
                                </thead>
                                <tbody>
                                <tr th:each="ex : ${reportData}">
                                    <td th:text="${ex.product.productName}">SP</td>
                                    <td th:text="${ex.exportDate}">Ng√†y</td>
                                    <td th:text="${ex.quantity}">SL</td>
                                    <td th:text="${ex.totalExportAmount}">T·ªïng</td>
                                    <td th:text="${ex.employee.fullName}">NV</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- IMPORT_EXPORT -->
                        <div th:case="'IMPORT_EXPORT'">
                            <h6 class="fw-bold mt-3">üìÖ Nh·∫≠p h√†ng</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead><tr><th>S·∫£n ph·∫©m</th><th>Ng√†y nh·∫≠p</th><th>S·ªë l∆∞·ª£ng</th><th>T·ªïng ti·ªÅn</th><th>Nh√¢n vi√™n</th></tr></thead>
                                    <tbody>
                                    <tr th:each="imp : ${reportData[0].imports}">
                                        <td th:text="${imp.product.productName}">SP</td>
                                        <td th:text="${imp.importDate}">Ng√†y</td>
                                        <td th:text="${imp.quantity}">SL</td>
                                        <td th:text="${imp.totalAmount}">T·ªïng</td>
                                        <td th:text="${imp.employee.fullName}">NV</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                            <h6 class="fw-bold mt-4">üìÑ Xu·∫•t h√†ng</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead><tr><th>S·∫£n ph·∫©m</th><th>Ng√†y xu·∫•t</th><th>S·ªë l∆∞·ª£ng</th><th>T·ªïng ti·ªÅn</th><th>Nh√¢n vi√™n</th></tr></thead>
                                    <tbody>
                                    <tr th:each="ex : ${reportData[0].exports}">
                                        <td th:text="${ex.product.productName}">SP</td>
                                        <td th:text="${ex.exportDate}">Ng√†y</td>
                                        <td th:text="${ex.quantity}">SL</td>
                                        <td th:text="${ex.totalExportAmount}">T·ªïng</td>
                                        <td th:text="${ex.employee.fullName}">NV</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</main>
</body>
</html>
